#!/bin/sh
#
# Pre-commit hook for Spring Modernization Marketplace
#
# This hook:
# 1. Runs pnpm lint to check for markdown issues
# 2. If lint fails, automatically fixes issues with pnpm lint:fix
# 3. Runs pnpm format to format all markdown files
# 4. Stages any auto-fixed changes
# 5. Allows commit to proceed
#

echo "Running pre-commit checks..."

# Get the list of staged markdown files
STAGED_MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.md$' || true)

if [ -z "$STAGED_MD_FILES" ]; then
  echo "No markdown files staged, skipping lint and format checks."
  exit 0
fi

echo "Staged markdown files:"
echo "$STAGED_MD_FILES"
echo ""

# Step 1: Run lint check
echo "Step 1: Running pnpm lint..."
if pnpm lint 2>/dev/null; then
  echo "Lint passed!"
else
  echo "Lint found issues. Attempting auto-fix..."

  # Step 2: Run lint:fix to automatically address issues
  echo "Step 2: Running pnpm lint:fix..."
  if pnpm lint:fix 2>/dev/null; then
    echo "Lint issues auto-fixed!"
  else
    echo "Warning: Some lint issues could not be auto-fixed."
    echo "Please review and fix manually, then try committing again."
    exit 1
  fi
fi

# Step 3: Run format
echo "Step 3: Running pnpm format..."
if pnpm format 2>/dev/null; then
  echo "Format complete!"
else
  echo "Error: Format failed."
  exit 1
fi

# Step 4: Re-stage any files that were modified by lint:fix or format
echo "Step 4: Re-staging modified files..."
for file in $STAGED_MD_FILES; do
  if [ -f "$file" ]; then
    git add "$file"
  fi
done

# Also check if any other markdown files were modified (in case lint:fix touched them)
MODIFIED_MD=$(git diff --name-only | grep '\.md$' || true)
if [ -n "$MODIFIED_MD" ]; then
  echo "Additional markdown files modified by lint/format:"
  echo "$MODIFIED_MD"
  echo ""
  echo "These files have been modified but were not originally staged."
  echo "Please review and stage them if needed, then commit again."
  exit 1
fi

echo ""
echo "Pre-commit checks passed! Proceeding with commit..."
exit 0
